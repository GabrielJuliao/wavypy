<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Waveform Viewer</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline';"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #1a1a1a;
        color: #e0e0e0;
      }
      .container {
        max-width: 100%;
      }
      h1 {
        margin: 0 0 20px;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        background: #2c6e31;
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #3c9341;
      }
      button:disabled {
        background: #444;
        color: #888;
        cursor: not-allowed;
      }
      .waveform-container {
        height: 300px;
        background: #000;
        border: 1px solid #555;
        border-radius: 4px;
      }
      canvas {
        display: block;
      }
      #time-info {
        margin: 10px 0;
        color: #aaa;
      }
      .file-input input[type="file"] {
        background: #333;
        color: #e0e0e0;
        border: 1px solid #555;
        padding: 5px;
        border-radius: 4px;
      }
      #loading {
        display: none;
        margin-left: 10px;
        color: #aaa;
      }
      .scroll-bar {
        width: 100%;
        height: 20px;
        background: #333;
        border: 1px solid #555;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Waveform Viewer</h1>
      <div class="file-input">
        <input type="file" id="file-input" accept=".json" />
        <span id="loading">Loading...</span>
      </div>
      <div class="controls">
        <button id="zoom-in">Zoom In</button>
        <button id="zoom-out">Zoom Out</button>
      </div>
      <div class="waveform-container">
        <canvas id="waveform"></canvas>
      </div>
      <div id="time-info">Duration: 0s | View: 0s - 0s</div>
      <input
        type="range"
        id="scroll-bar"
        class="scroll-bar"
        min="0"
        max="100"
        value="0"
        disabled
      />
    </div>

    <script>
      class WaveformRenderer {
        constructor(canvasId) {
          this.canvas = document.getElementById(canvasId);
          this.ctx = this.canvas.getContext("2d");
          this.data = null;
          this.zoom = 1;
          this.offset = 0;
          this.colors = {
            low: "#0055e2", // Blue for low
            mid: "#f2aa3c", // Orange for mid
            high: "#ffffff", // White for high
            bg: "#000000",
            center: "#ccc",
          };
          this.resize();
          window.addEventListener("resize", () => this.resize());
        }

        resize() {
          this.canvas.width = this.canvas.parentElement.clientWidth;
          this.canvas.height = 300;
          this.render();
        }

        async loadData(json) {
          this.data = json;
          for (const band of this.data.data.multiband.bands) {
            band.samples = await this.decodeSamples(
              band.samples,
              band.sample_format,
              this.data.bits_per_sample
            );
          }
          this.render();
          this.updateTime();
          this.enableControls();
          this.updateScroll();
        }

        async decodeSamples(samples, format, bits) {
          const binary = atob(samples);
          const bytes = new Uint8Array(
            [...binary].map((ch) => ch.charCodeAt(0))
          );
          const view = new DataView(bytes.buffer);
          const count = bytes.length / (bits === 8 ? 1 : 2);
          const result = new Int16Array(count);
          for (let i = 0; i < count; i++) {
            result[i] =
              bits === 8 ? view.getInt8(i) * 256 : view.getInt16(i * 2, true);
          }
          return result;
        }

        zoomIn() {
          if (this.zoom < 10) {
            this.zoom *= 1.5;
            this.adjustOffset();
            this.render();
            this.updateTime();
            this.updateScroll();
          }
        }

        zoomOut() {
          if (this.zoom > 0.1) {
            this.zoom /= 1.5;
            this.adjustOffset();
            this.render();
            this.updateTime();
            this.updateScroll();
          }
        }

        adjustOffset() {
          const visible = this.canvas.width / this.zoom;
          const total =
            this.data?.data.multiband.bands[0].samples.length / 2 || 0;
          this.offset = Math.max(0, Math.min(this.offset, total - visible));
        }

        render() {
          const { width, height } = this.canvas;
          this.ctx.fillStyle = this.colors.bg;
          this.ctx.fillRect(0, 0, width, height);

          if (!this.data) return this.renderEmpty();

          const center = height / 2;
          this.ctx.beginPath();
          this.ctx.moveTo(0, center);
          this.ctx.lineTo(width, center);
          this.ctx.strokeStyle = this.colors.center;
          this.ctx.stroke();

          ["low", "mid", "high"].forEach((band) =>
            this.renderBand(band, center)
          );
        }

        renderBand(bandName, center) {
          const band = this.data.data.multiband.bands.find(
            (b) => b.name === bandName
          );
          if (!band) return;

          const samples = band.samples;
          const start = Math.floor(this.offset);
          const end = Math.min(
            Math.ceil(this.offset + this.canvas.width / this.zoom),
            samples.length / 2
          );
          const scale = (this.canvas.height / 2) * 0.8;

          this.ctx.beginPath();
          this.ctx.moveTo(0, center);
          for (let i = start; i < end; i++) {
            const x = (i - this.offset) * this.zoom;
            const max = center - (samples[i * 2 + 1] / 32768) * scale;
            this.ctx.lineTo(x, max);
          }
          for (let i = end - 1; i >= start; i--) {
            const x = (i - this.offset) * this.zoom;
            const min = center - (samples[i * 2] / 32768) * scale;
            this.ctx.lineTo(x, min);
          }
          this.ctx.closePath();
          this.ctx.fillStyle = this.colors[bandName];
          this.ctx.fill();
        }

        renderEmpty() {
          this.ctx.fillStyle = "#666";
          this.ctx.font = "14px Arial";
          this.ctx.textAlign = "center";
          this.ctx.fillText(
            "Upload a waveform JSON file",
            this.canvas.width / 2,
            this.canvas.height / 2
          );
        }

        updateTime() {
          if (!this.data) return;
          const { samples_per_pixel, sample_rate } = this.data;
          const total =
            ((this.data.data.multiband.bands[0].samples.length / 2) *
              samples_per_pixel) /
            sample_rate;
          const start = (this.offset * samples_per_pixel) / sample_rate;
          const end = Math.min(
            total,
            start +
              ((this.canvas.width / this.zoom) * samples_per_pixel) /
                sample_rate
          );
          document.getElementById(
            "time-info"
          ).textContent = `Duration: ${total.toFixed(
            2
          )}s | View: ${start.toFixed(2)}s - ${end.toFixed(2)}s`;
        }

        enableControls() {
          ["zoom-in", "zoom-out", "scroll-bar"].forEach(
            (id) => (document.getElementById(id).disabled = false)
          );
        }

        updateScroll() {
          const scroll = document.getElementById("scroll-bar");
          const total = this.data.data.multiband.bands[0].samples.length / 2;
          const visible = this.canvas.width / this.zoom;
          scroll.max = Math.max(0, total - visible);
          scroll.value = this.offset;
          scroll.disabled = total <= visible;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const renderer = new WaveformRenderer("waveform");

        document
          .getElementById("zoom-in")
          .addEventListener("click", () => renderer.zoomIn());
        document
          .getElementById("zoom-out")
          .addEventListener("click", () => renderer.zoomOut());
        document.getElementById("scroll-bar").addEventListener("input", (e) => {
          renderer.offset = +e.target.value;
          renderer.render();
          renderer.updateTime();
        });

        document
          .getElementById("file-input")
          .addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById("loading").style.display = "inline";
            try {
              const json = JSON.parse(await file.text());
              if (json.type !== "multiband")
                throw new Error("Only multiband waveforms supported");
              await renderer.loadData(json);
            } catch (err) {
              alert("Error: " + err.message);
            } finally {
              document.getElementById("loading").style.display = "none";
            }
          });
      });
    </script>
  </body>
</html>
